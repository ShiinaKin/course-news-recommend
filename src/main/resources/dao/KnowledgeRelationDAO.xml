<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.sakurasou.newsrecommend.dao.KnowledgeRelationDAO">

  <resultMap id="KnowledgeRelationResult" type="io.sakurasou.newsrecommend.model.graph.KnowledgeRelation">
    <id column="id" property="id"/>
    <result column="source_id" property="sourceId"/>
    <result column="target_id" property="targetId"/>
    <result column="relation_type" property="relationType"/>
    <result column="modality" property="modality"/>
    <result column="weight" property="weight"/>
    <result column="created_at" property="createdAt"/>
    <result column="updated_at" property="updatedAt"/>
  </resultMap>

  <select id="findRelation" resultMap="KnowledgeRelationResult">
    SELECT id, source_id, target_id, relation_type, modality, weight, created_at, updated_at
    FROM knowledge_relations
    WHERE source_id = #{sourceId}
      AND target_id = #{targetId}
      AND relation_type = #{relationType}
      AND modality = #{modality}
    LIMIT 1
  </select>

  <select id="findAll" resultMap="KnowledgeRelationResult">
    SELECT id, source_id, target_id, relation_type, modality, weight, created_at, updated_at
    FROM knowledge_relations
    ORDER BY id
  </select>

  <insert id="insert"
          parameterType="io.sakurasou.newsrecommend.model.graph.KnowledgeRelation"
          useGeneratedKeys="true" keyProperty="id">
    INSERT INTO knowledge_relations (source_id, target_id, relation_type, modality, weight)
    VALUES (#{sourceId}, #{targetId}, #{relationType}, #{modality}, #{weight})
  </insert>

  <update id="updateWeight">
    UPDATE knowledge_relations
    SET weight = #{weight},
        updated_at = CURRENT_TIMESTAMP
    WHERE id = #{id}
  </update>

</mapper>
